{"version":3,"file":"L.GBFS.js","sources":["../src/L.GBFS.js"],"sourcesContent":["import './L.GBFS.css';\n\nimport {\n  Layer, GeoJSON, Marker, Icon, DivIcon, LatLng, setOptions,\n} from 'leaflet';\n\n// const iconUrl = require('./images/bike_icon.png');\nconst iconUrl = new URL('./images/bike_icon.png', document.currentScript.src);\n\nconst GBFS = Layer.extend({\n  options: {\n    gbfsURL: '',\n    language: null,\n    start: true,\n    interval: 60 * 1000,\n    onlyRunWhenAdded: false,\n    bikeMarkerColor: 'white',\n    bikeMarkerBgColor: 'silver',\n    stationMarkerBgColor: '#8C2BF2',\n    showStationPopup: true,\n    showBikePopup: true,\n  },\n\n  initialize(options) {\n    setOptions(this, options);\n    this.container = new GeoJSON(null, options);\n    this.updating = false;\n\n    if (this.options.start && !this.options.onlyRunWhenAdded) {\n      this.start();\n    }\n  },\n\n  async start() {\n    if (this.feeds) { // already started\n      return this;\n    }\n    try {\n      const gbfsResponse = await fetch(this.options.gbfsURL);\n      const gbfs = await gbfsResponse.json();\n      if (this.options.language) {\n        if (!Object.prototype.hasOwnProperty.call(gbfs.data, this.options.language)) {\n          throw new Error(`defined language (${this.options.language}) missing in gbfs file`);\n        }\n      } else {\n        const languages = Object.keys(gbfs.data);\n        if (languages.length === 0) {\n          throw new Error('GBFS has no languages defined');\n        } else {\n          this.options.language = languages[0];\n        }\n      }\n\n      const feeds = gbfs.data[this.options.language].feeds;\n      const systemInformation = feeds.find((el) => el.name === 'system_information');\n      const systemInfoResponse = await fetch(systemInformation.url);\n      this.systemInformation = await systemInfoResponse.json();\n\n      const stationInformation = feeds.find((el) => el.name === 'station_information');\n      const stationStatus = feeds.find((el) => el.name === 'station_status');\n      const freeBikeStatus = feeds.find((el) => el.name === 'free_bike_status');\n      // const vehicleTypes = feeds.find((el) => el.name === 'vehicle_types');\n\n      this.feeds = {\n        stationInformation, stationStatus, freeBikeStatus, // vehicleTypes,\n      };\n      this.stations = {};\n\n      if (!this.timer) {\n        this.timer = setInterval(() => this.update(), this.options.interval);\n        this.update();\n      }\n    } catch (err) {\n      console.warn(err);\n      this.fire('error', { error: err });\n    }\n\n    return this;\n  },\n\n  stop() {\n    if (this.timer) {\n      clearTimeout(this.timer);\n      delete this.timer;\n    }\n\n    return this;\n  },\n\n  isRunning() {\n    return this.timer !== undefined;\n  },\n\n  isUpdating() {\n    return this.updating;\n  },\n\n  async update() {\n    if (typeof this.feeds === 'undefined') {\n      return this;\n    }\n    try {\n      this.updating = true;\n      let stations;\n      const stationStatusResponse = await fetch(this.feeds.stationStatus.url);\n      const stationStatus = await stationStatusResponse.json();\n      let freeBikeStatus;\n      if (typeof this.feeds.freeBikeStatus !== 'undefined') {\n        const freeBikeStatusResponse = await fetch(this.feeds.freeBikeStatus.url);\n        freeBikeStatus = await freeBikeStatusResponse.json();\n      }\n      let vehicleTypes;\n      if (typeof this.feeds.vehicleTypes !== 'undefined') {\n        const vehicleTypesResponse = await fetch(this.feeds.vehicleTypes.url);\n        vehicleTypes = await vehicleTypesResponse.json();\n      }\n\n      this.container.clearLayers();\n\n      for (const status of stationStatus.data.stations) {\n        if (status.is_installed) {\n          let station = this.stations[status.station_id];\n          if (!station) {\n            /* eslint-disable no-await-in-loop */\n            const stationInformationResponse = await fetch(this.feeds.stationInformation.url);\n            stations = await stationInformationResponse.json();\n            /* eslint-enable */\n            stations.data.stations.forEach((st) => {\n              this.stations[st.station_id] = st;\n            });\n            station = this.stations[status.station_id];\n          }\n          const icon = new DivIcon({\n            html: this.getStationIconHtml(status.num_bikes_available, status.num_docks_available),\n            bgPos: [16, 16],\n            iconSize: [32, 32],\n            popupAnchor: [0, -21],\n            className: 'station-icon',\n          });\n          const point = new LatLng(station.lat, station.lon);\n          const marker = new Marker(point, {\n            icon,\n          });\n          if (this.options.showStationPopup) {\n            marker.bindPopup(`<b>${station.name}</b><br>Available bikes: <b>${status.num_bikes_available}</b>`);\n          }\n          marker.on('click', (e) => this.fire('stationClick', { event: e, station, status }));\n          marker.addTo(this.container);\n        }\n      }\n\n      const icon = new Icon({\n        iconSize: [32, 32],\n        popupAnchor: [0, -20],\n        iconUrl,\n      });\n\n      if (typeof freeBikeStatus !== 'undefined') {\n        freeBikeStatus.data.bikes.forEach((bike) => {\n          const point = new LatLng(bike.lat, bike.lon);\n          const marker = new Marker(point, {\n            icon,\n          });\n          if (this.options.showBikePopup) {\n            marker.bindPopup('Bike available');\n          }\n          marker.on('click', (e) => this.fire('bikeClick', { event: e, bike }));\n          marker.addTo(this.container);\n        });\n      }\n\n      const dataUpdate = { stationStatus };\n      if (typeof stations !== 'undefined') dataUpdate.stations = stations;\n      if (typeof freeBikeStatus !== 'undefined') dataUpdate.freeBikeStatus = freeBikeStatus;\n      if (typeof vehicleTypes !== 'undefined') dataUpdate.vehicleTypes = vehicleTypes;\n      this.fire('data', dataUpdate);\n    } catch (err) {\n      this.updating = false;\n      console.warn(err);\n      this.fire('error', { error: err });\n    }\n\n    this.updating = false;\n    return this;\n  },\n\n  getBounds() {\n    if (this.container.getBounds) {\n      return this.container.getBounds();\n    }\n\n    throw new Error('Container has no getBounds method');\n  },\n\n  onAdd(map) {\n    map.addLayer(this.container);\n    if (this.options.start) {\n      this.start();\n    }\n  },\n\n  onRemove(map) {\n    if (this.options.onlyRunWhenAdded) {\n      this.stop();\n    }\n\n    map.removeLayer(this.container);\n  },\n\n  getStationIconHtml(bikes, docks) {\n    let stationCss = `background: ${this.options.stationMarkerBgColor};`;\n    if (bikes === 0) {\n      stationCss = `background: color-mix(in srgb, ${this.options.stationMarkerBgColor} 50%, transparent);`;\n    }\n    const degree = (bikes / (bikes + docks)) * 360;\n    let ringCss = `\n      background: ${this.options.bikeMarkerColor};\n      background-image:\n        linear-gradient(${90 + degree}deg, transparent 50%, ${this.options.bikeMarkerBgColor} 50%),\n        linear-gradient(90deg, ${this.options.bikeMarkerBgColor} 50%, transparent 50%);\n    `;\n\n    if (degree > 180) {\n      ringCss = `\n        background: ${this.options.bikeMarkerColor};\n        background-image:\n          linear-gradient(${degree - 90}deg, transparent 50%, ${this.options.bikeMarkerColor} 50%),\n          linear-gradient(90deg, ${this.options.bikeMarkerBgColor} 50%, transparent 50%);\n      `;\n    }\n    return `\n      <div class=\"station-icon-ring\" style=\"${ringCss}\">\n        <div class=\"station-icon-inner\" style=\"${stationCss}\">${bikes}</div>\n      </div>\n    `;\n  },\n});\n\nexport default GBFS;\n"],"names":["_catch","body","recover","result","e","then","iconUrl","URL","document","currentScript","src","Symbol","iterator","_settle","pact","state","value","s","_Pact","o","bind","v","observer","prototype","onFulfilled","onRejected","this","callback","_this","_isSettledPact","thenable","Layer","extend","options","gbfsURL","language","start","interval","onlyRunWhenAdded","bikeMarkerColor","bikeMarkerBgColor","stationMarkerBgColor","showStationPopup","showBikePopup","initialize","setOptions","container","GeoJSON","updating","feeds","fetch","gbfsResponse","json","gbfs","Object","hasOwnProperty","call","data","Error","languages","keys","length","systemInformation","find","el","name","url","systemInfoResponse","stationInformation","stationStatus","freeBikeStatus","stations","timer","setInterval","update","err","console","warn","fire","error","stop","clearTimeout","isRunning","undefined","isUpdating","_this2","stationStatusResponse","icon","Icon","iconSize","popupAnchor","bikes","forEach","bike","point","LatLng","lat","lon","marker","Marker","bindPopup","on","event","addTo","dataUpdate","vehicleTypes","clearLayers","target","check","step","reject","_cycle","next","done","return","_fixup","TypeError","values","i","push","array","status","is_installed","DivIcon","html","getStationIconHtml","num_bikes_available","num_docks_available","bgPos","className","station","station_id","stationInformationResponse","st","vehicleTypesResponse","freeBikeStatusResponse","getBounds","onAdd","map","addLayer","onRemove","removeLayer","docks","stationCss","degree","ringCss"],"mappings":"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"}
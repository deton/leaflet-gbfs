this.L=this.L||{},this.L.GBFS=function(n){function t(n,t){try{var e=n()}catch(n){return t(n)}return e&&e.then?e.then(void 0,t):e}const e=new URL("./images/bike_icon.png",document.currentScript.src),o="undefined"!=typeof Symbol?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function i(n,t,e){if(!n.s){if(e instanceof r){if(!e.s)return void(e.o=i.bind(null,n,t));1&t&&(t=e.s),e=e.v}if(e&&e.then)return void e.then(i.bind(null,n,t),i.bind(null,n,2));n.s=t,n.v=e;const o=n.o;o&&o(n)}}const r=function(){function n(){}return n.prototype.then=function(t,e){const o=new n,r=this.s;if(r){const n=1&r?t:e;if(n){try{i(o,1,n(this.v))}catch(n){i(o,2,n)}return o}return this}return this.o=function(n){try{const r=n.v;1&n.s?i(o,1,t?t(r):r):e?i(o,1,e(r)):i(o,2,r)}catch(n){i(o,2,n)}},o},n}();function s(n){return n instanceof r&&1&n.s}return n.Layer.extend({options:{gbfsURL:"",language:null,start:!0,interval:6e4,onlyRunWhenAdded:!1,bikeMarkerColor:"white",bikeMarkerBgColor:"silver",stationMarkerBgColor:"#8C2BF2",showStationPopup:!0,showBikePopup:!0},initialize(t){n.setOptions(this,t),this.container=new n.GeoJSON(null,t),this.updating=!1,this.options.start&&!this.options.onlyRunWhenAdded&&this.start()},start:function(){try{let n;const e=this;if(e.feeds)return Promise.resolve(e);const o=t(function(){return Promise.resolve(fetch(e.options.gbfsURL)).then(function(n){return Promise.resolve(n.json()).then(function(n){if(e.options.language){if(!Object.prototype.hasOwnProperty.call(n.data,e.options.language))throw new Error(`defined language (${e.options.language}) missing in gbfs file`)}else{const t=Object.keys(n.data);if(0===t.length)throw new Error("GBFS has no languages defined");e.options.language=t[0]}const t=n.data[e.options.language].feeds,o=t.find(n=>"system_information"===n.name);return Promise.resolve(fetch(o.url)).then(function(n){return Promise.resolve(n.json()).then(function(n){e.systemInformation=n;const o=t.find(n=>"station_information"===n.name),i=t.find(n=>"station_status"===n.name),r=t.find(n=>"free_bike_status"===n.name);e.feeds={stationInformation:o,stationStatus:i,freeBikeStatus:r},e.stations={},e.timer||(e.timer=setInterval(()=>e.update(),e.options.interval),e.update())})})})})},function(n){console.warn(n),e.fire("error",{error:n})});return Promise.resolve(o&&o.then?o.then(function(t){return n?t:e}):n?o:e)}catch(n){return Promise.reject(n)}},stop(){return this.timer&&(clearTimeout(this.timer),delete this.timer),this},isRunning(){return void 0!==this.timer},isUpdating(){return this.updating},update:function(){try{const u=this;function a(){return u.updating=!1,u}if(void 0===u.feeds)return Promise.resolve(u);const c=t(function(){let t;return u.updating=!0,Promise.resolve(fetch(u.feeds.stationStatus.url)).then(function(a){return Promise.resolve(a.json()).then(function(a){function c(){function c(){function c(){const o=new n.Icon({iconSize:[32,32],popupAnchor:[0,-20],iconUrl:e});void 0!==l&&l.data.bikes.forEach(t=>{const e=new n.LatLng(t.lat,t.lon),i=new n.Marker(e,{icon:o});u.options.showBikePopup&&i.bindPopup("Bike available"),i.on("click",n=>u.fire("bikeClick",{event:n,bike:t})),i.addTo(u.container)});const i={stationStatus:a};void 0!==t&&(i.stations=t),void 0!==l&&(i.freeBikeStatus=l),void 0!==f&&(i.vehicleTypes=f),u.fire("data",i)}u.container.clearLayers();const h=function(n,t,e){if("function"==typeof n[o]){var a,u,c,l=n[o]();if(function n(e){try{for(;!(a=l.next()).done;)if((e=t(a.value))&&e.then){if(!s(e))return void e.then(n,c||(c=i.bind(null,u=new r,2)));e=e.v}u?i(u,1,e):u=e}catch(n){i(u||(u=new r),2,n)}}(),l.return){var f=function(n){try{a.done||l.return()}catch(n){}return n};if(u&&u.then)return u.then(f,function(n){throw f(n)});f()}return u}if(!("length"in n))throw new TypeError("Object is not iterable");for(var h=[],d=0;d<n.length;d++)h.push(n[d]);return function(n,t,e){var o,a,u=-1;return function e(c){try{for(;++u<n.length;)if((c=t(u))&&c.then){if(!s(c))return void c.then(e,a||(a=i.bind(null,o=new r,2)));c=c.v}o?i(o,1,c):o=c}catch(n){i(o||(o=new r),2,n)}}(),o}(h,function(n){return t(h[n])})}(a.data.stations,function(e){const o=function(){if(e.is_installed){function o(){const t=new n.DivIcon({html:u.getStationIconHtml(e.num_bikes_available,e.num_docks_available),bgPos:[16,16],iconSize:[32,32],popupAnchor:[0,-21],className:"station-icon"}),o=new n.LatLng(i.lat,i.lon),r=new n.Marker(o,{icon:t});u.options.showStationPopup&&r.bindPopup(`<b>${i.name}</b><br>Available bikes: <b>${e.num_bikes_available}</b>`),r.on("click",n=>u.fire("stationClick",{event:n,station:i,status:e})),r.addTo(u.container)}let i=u.stations[e.station_id];const r=function(){if(!i)return Promise.resolve(fetch(u.feeds.stationInformation.url)).then(function(n){return Promise.resolve(n.json()).then(function(n){t=n,t.data.stations.forEach(n=>{u.stations[n.station_id]=n}),i=u.stations[e.station_id]})})}();return r&&r.then?r.then(o):o()}}();if(o&&o.then)return o.then(function(){})});return h&&h.then?h.then(c):c()}let f;const h=function(){if(void 0!==u.feeds.vehicleTypes)return Promise.resolve(fetch(u.feeds.vehicleTypes.url)).then(function(n){return Promise.resolve(n.json()).then(function(n){f=n})})}();return h&&h.then?h.then(c):c()}let l;const f=function(){if(void 0!==u.feeds.freeBikeStatus)return Promise.resolve(fetch(u.feeds.freeBikeStatus.url)).then(function(n){return Promise.resolve(n.json()).then(function(n){l=n})})}();return f&&f.then?f.then(c):c()})})},function(n){u.updating=!1,console.warn(n),u.fire("error",{error:n})});return Promise.resolve(c&&c.then?c.then(a):a())}catch(n){return Promise.reject(n)}},getBounds(){if(this.container.getBounds)return this.container.getBounds();throw new Error("Container has no getBounds method")},onAdd(n){n.addLayer(this.container),this.options.start&&this.start()},onRemove(n){this.options.onlyRunWhenAdded&&this.stop(),n.removeLayer(this.container)},getStationIconHtml(n,t){let e=`background: ${this.options.stationMarkerBgColor};`;0===n&&(e=`background: color-mix(in srgb, ${this.options.stationMarkerBgColor} 50%, transparent);`);const o=n/(n+t)*360;let i=`\n      background: ${this.options.bikeMarkerColor};\n      background-image:\n        linear-gradient(${90+o}deg, transparent 50%, ${this.options.bikeMarkerBgColor} 50%),\n        linear-gradient(90deg, ${this.options.bikeMarkerBgColor} 50%, transparent 50%);\n    `;return o>180&&(i=`\n        background: ${this.options.bikeMarkerColor};\n        background-image:\n          linear-gradient(${o-90}deg, transparent 50%, ${this.options.bikeMarkerColor} 50%),\n          linear-gradient(90deg, ${this.options.bikeMarkerBgColor} 50%, transparent 50%);\n      `),`\n      <div class="station-icon-ring" style="${i}">\n        <div class="station-icon-inner" style="${e}">${n}</div>\n      </div>\n    `}})}(L);
//# sourceMappingURL=L.GBFS.js.map

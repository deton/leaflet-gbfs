import{Layer as t,setOptions as i,GeoJSON as s,DivIcon as n,LatLng as e,Marker as o,Icon as a}from"leaflet";const r=new URL("./images/bike_icon.png",document.currentScript.src),h=t.extend({options:{gbfsURL:"",gbfsFiles:null,language:null,start:!0,interval:6e4,onlyRunWhenAdded:!1,bikeMarkerColor:"white",bikeMarkerBgColor:"silver",stationMarkerBgColor:"#8C2BF2",showStationPopup:!0,showBikePopup:!0},initialize(t){i(this,t),this.container=new s(null,t),this.updating=!1,this.options.start&&!this.options.onlyRunWhenAdded&&this.start()},async start(){if(this.feeds)return this;if(this.options.gbfsFiles){this.stations={},this.feeds={};for(const t of this.options.gbfsFiles)if("station_information.json"===t.name)this.feeds.stationInformation=t;else if("station_status.json"===t.name)this.feeds.stationStatus=t;else if("system_information.json"===t.name){const i=await t.text();this.systemInformation=JSON.parse(i)}return this.update(),this}try{const t=await fetch(this.options.gbfsURL),i=await t.json();if(this.options.language){if(!Object.prototype.hasOwnProperty.call(i.data,this.options.language))throw new Error(`defined language (${this.options.language}) missing in gbfs file`)}else{const t=Object.keys(i.data);if(0===t.length)throw new Error("GBFS has no languages defined");this.options.language=t[0]}const s=i.data[this.options.language].feeds,n=s.find(t=>"system_information"===t.name),e=await fetch(n.url);this.systemInformation=await e.json();const o=s.find(t=>"station_information"===t.name),a=s.find(t=>"station_status"===t.name),r=s.find(t=>"free_bike_status"===t.name);this.feeds={stationInformation:o,stationStatus:a,freeBikeStatus:r},this.stations={},!this.timer&&this.options.interval>0&&(this.timer=setInterval(()=>this.update(),this.options.interval),this.update())}catch(t){console.warn(t),this.fire("error",{error:t})}return this},stop(){return this.timer&&(clearTimeout(this.timer),delete this.timer),this},isRunning(){return void 0!==this.timer},isUpdating(){return this.updating},async update(){if(void 0===this.feeds)return this;try{let t,i,s,h;if(this.updating=!0,"string"==typeof this.feeds.stationStatus.url){const i=await fetch(this.feeds.stationStatus.url);t=await i.json()}else{const i=await this.feeds.stationStatus.text();t=JSON.parse(i)}if(void 0!==this.feeds.freeBikeStatus){const t=await fetch(this.feeds.freeBikeStatus.url);s=await t.json()}if(void 0!==this.feeds.vehicleTypes){const t=await fetch(this.feeds.vehicleTypes.url);h=await t.json()}this.container.clearLayers();for(const s of t.data.stations)if(s.is_installed){let t=this.stations[s.station_id];if(!t){if("string"==typeof this.feeds.stationInformation.url){const t=await fetch(this.feeds.stationInformation.url);i=await t.json()}else{const t=await this.feeds.stationInformation.text();i=JSON.parse(t)}i.data.stations.forEach(t=>{this.stations[t.station_id]=t}),t=this.stations[s.station_id]}const a=new n({html:this.getStationIconHtml(s.num_bikes_available,s.num_docks_available),bgPos:[16,16],iconSize:[32,32],popupAnchor:[0,-21],className:"station-icon"}),r=new e(t.lat,t.lon),h=new o(r,{icon:a});this.options.showStationPopup&&h.bindPopup(`<b>${t.name}</b><br>Available bikes: <b>${s.num_bikes_available}</b>`),h.on("click",i=>this.fire("stationClick",{event:i,station:t,status:s})),h.addTo(this.container)}const l=new a({iconSize:[32,32],popupAnchor:[0,-20],iconUrl:r});void 0!==s&&s.data.bikes.forEach(t=>{const i=new e(t.lat,t.lon),s=new o(i,{icon:l});this.options.showBikePopup&&s.bindPopup("Bike available"),s.on("click",i=>this.fire("bikeClick",{event:i,bike:t})),s.addTo(this.container)});const d={stationStatus:t};void 0!==i&&(d.stations=i),void 0!==s&&(d.freeBikeStatus=s),void 0!==h&&(d.vehicleTypes=h),this.fire("data",d)}catch(t){this.updating=!1,console.warn(t),this.fire("error",{error:t})}return this.updating=!1,this},getBounds(){if(this.container.getBounds)return this.container.getBounds();throw new Error("Container has no getBounds method")},onAdd(t){t.addLayer(this.container),this.options.start&&this.start()},onRemove(t){this.options.onlyRunWhenAdded&&this.stop(),t.removeLayer(this.container)},getStationIconHtml(t,i){let s=`background: ${this.options.stationMarkerBgColor};`;0===t&&(s=`background: color-mix(in srgb, ${this.options.stationMarkerBgColor} 50%, transparent);`);const n=t/(t+i)*360;let e=`\n      background: ${this.options.bikeMarkerColor};\n      background-image:\n        linear-gradient(${90+n}deg, transparent 50%, ${this.options.bikeMarkerBgColor} 50%),\n        linear-gradient(90deg, ${this.options.bikeMarkerBgColor} 50%, transparent 50%);\n    `;return n>180&&(e=`\n        background: ${this.options.bikeMarkerColor};\n        background-image:\n          linear-gradient(${n-90}deg, transparent 50%, ${this.options.bikeMarkerColor} 50%),\n          linear-gradient(90deg, ${this.options.bikeMarkerBgColor} 50%, transparent 50%);\n      `),`\n      <div class="station-icon-ring" style="${e}">\n        <div class="station-icon-inner" style="${s}">${t}</div>\n      </div>\n    `}});export default h;
//# sourceMappingURL=L.GBFS.esm.js.map

<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Leaflet GBFS</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <link rel="stylesheet" href="../dist/L.GBFS.css" />
        <style>
            #map {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                right: 0;
            }
            #toolbar {
                position: absolute;
                top: 5px;
                left: 60px;
                z-index: 1000;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="toolbar" class="leaflet-control">
            <a id="exportData"><button id="exportDataButton" onclick="exportData()">Export data</button></a>
        </div>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet-src.js"></script>
        <script src="../dist/L.GBFS.js"></script>

        <script type="text/javascript">
            var map = L.map('map');

            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            }).addTo(map);

            const urlParams = new URLSearchParams(document.location.search);
            let lat = Number(urlParams.get('lat') || '35.5403');
            let lon = Number(urlParams.get('lon') || '139.6987');
            let zoom = +urlParams.get('zoom') || 14;
            map.setView([lat, lon], zoom);

            let gbfsColors = urlParams.getAll('gbfsColor');
            let gbfsUrls = urlParams.getAll('gbfsUrl');
            if (gbfsUrls.length === 0) {
                gbfsUrls = [
                    'https://api-public.odpt.org/api/v4/gbfs/docomo-cycle/gbfs.json',
                    'https://api-public.odpt.org/api/v4/gbfs/hellocycling/gbfs.json',
                ];
                if (gbfsColors.length === 0) {
                    // XXX: use brand_assets.color from system_information.json
                    gbfsColors = ['#cc0033', '#fabe00'];
                }
            }
            const layerControl = L.control.layers(null, null, { collapsed: false }).addTo(map);
            const historyDatas = new Array(gbfsUrls.length);
            const gbfsLayers = gbfsUrls.map((url, idx) => {
                historyDatas[idx] = {};
                const gbfs = new L.GBFS({
                    gbfsURL: url,
                    stationMarkerBgColor: (idx < gbfsColors.length) ? gbfsColors[idx] : undefined,
                });
                gbfs.on('data', onDataUpdate);
                return gbfs;

                function onDataUpdate(data) {
                    if (!layerControl._getLayer(L.Util.stamp(gbfs))) {
                        gbfs.addTo(map);
                        layerControl.addOverlay(gbfs, gbfs.systemInformation.data.system_id);
                    }
                    const timekey = data.stationStatus.last_updated;
                    if (!historyDatas[idx][timekey]) {
                        historyDatas[idx][timekey] = {
                            stationStatus: data.stationStatus,
                            stations: data.stations,
                        }; // not to include 'sourceTarget', 'target' for event
                    }
                }
            });

            function exportData() {
                const file = new File([JSON.stringify(historyDatas)], 'historydata.json', {
                  type: 'application/json'
                });
                const exportDataElem = document.getElementById("exportData");
                exportDataElem.href = URL.createObjectURL(file);
                exportDataElem.download = file.name;
                //exportDataElem.click();
                URL.revokeObjectURL(exportDataElem.href);
            }
        </script>
    </body>
</html>
